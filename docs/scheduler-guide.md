# 定时任务和数据拉取系统使用指南

本系统提供了自动化的日线数据拉取功能，包括定时任务和手动执行两种方式。

## 功能概述

### 1. 定时任务系统
- **自动执行**: 每天下午4点半自动拉取所有加密货币的日线数据
- **任务管理**: 支持添加、移除、暂停、恢复定时任务
- **状态监控**: 可查看所有定时任务的运行状态

### 2. 手动执行工具
- **即时拉取**: 可随时手动执行全部日线数据拉取
- **进度显示**: 显示拉取进度和耗时统计
- **错误处理**: 完善的错误处理和日志记录

## 使用方法

### 启动定时任务调度器

```bash
# 启动定时任务调度器（会持续运行）
npm run scheduler:start

# 或者直接使用node命令
node --import ./loader.js scripts/startScheduler.js
```

启动后，系统会：
- 初始化定时任务调度器
- 添加每日16:30的日线数据拉取任务
- 显示当前任务状态
- 保持运行状态，等待定时执行

### 查看定时任务状态

```bash
# 查看当前所有定时任务的状态
npm run scheduler:status

# 或者
node --import ./loader.js scripts/startScheduler.js --status
```

### 手动执行日线数据拉取

```bash
# 手动拉取所有日线数据
npm run fetch:daylines

# 或者
node --import ./loader.js scripts/fetchDayLines.js
```

### 查看帮助信息

```bash
# 查看日线数据拉取工具帮助
npm run fetch:daylines -- --help

# 查看定时任务管理工具帮助
npm run scheduler:start -- --help
```

## 系统架构

### 核心模块

1. **scheduler.js** - 定时任务调度器核心
   - 基于 `node-cron` 实现
   - 支持任务的增删改查和状态管理
   - 使用中国时区（Asia/Shanghai）

2. **dailyTaskService.js** - 日常任务服务
   - 初始化定时任务
   - 提供手动执行接口

3. **dayLineFetcher.js** - 日线数据拉取器
   - 从API获取数据
   - 数据转换和存储
   - 智能更新（只拉取缺失的数据）

### 脚本文件

1. **scripts/startScheduler.js** - 定时任务启动脚本
2. **scripts/fetchDayLines.js** - 手动数据拉取脚本

## 定时任务配置

### 默认任务

| 任务名称 | Cron表达式 | 执行时间 | 功能描述 |
|---------|-----------|----------|----------|
| daily-dayline-fetch | `30 16 * * *` | 每天16:30 | 拉取所有加密货币日线数据 |

### Cron表达式说明

```
┌───────────── 分钟 (0 - 59)
│ ┌─────────── 小时 (0 - 23)
│ │ ┌───────── 日期 (1 - 31)
│ │ │ ┌─────── 月份 (1 - 12)
│ │ │ │ ┌───── 星期 (0 - 6) (0为周日)
│ │ │ │ │
* * * * *
```

示例：
- `30 16 * * *` - 每天16:30执行
- `0 9 * * 1-5` - 周一到周五的9:00执行
- `0 */2 * * *` - 每2小时执行一次

## 日志和监控

### 日志位置
- 系统日志通过 `utils/logger.js` 统一管理
- 定时任务执行情况会记录详细日志
- 错误信息会同时输出到控制台和日志文件

### 监控要点
- 定时任务是否正常启动
- 数据拉取是否成功完成
- API调用是否有频率限制问题
- 数据库连接是否稳定

## 注意事项

1. **时区设置**: 系统使用中国时区（Asia/Shanghai），确保定时任务按北京时间执行

2. **API限制**: 数据拉取有1秒间隔，避免API调用过于频繁

3. **数据去重**: 系统会自动检查是否已有当日数据，避免重复拉取

4. **错误恢复**: 单个币种拉取失败不会影响其他币种的处理

5. **进程管理**: 定时任务调度器需要保持运行状态，建议使用进程管理工具（如PM2）在生产环境中部署

## 故障排除

### 常见问题

1. **定时任务未执行**
   - 检查调度器是否正在运行
   - 确认时区设置是否正确
   - 查看日志文件中的错误信息

2. **数据拉取失败**
   - 检查网络连接
   - 确认API密钥是否有效
   - 查看API调用频率是否超限

3. **脚本无法启动**
   - 确认依赖包已正确安装
   - 检查文件路径是否正确
   - 确认数据库连接配置

### 调试命令

```bash
# 检查定时任务状态
npm run scheduler:status

# 手动测试数据拉取
npm run fetch:daylines

# 查看详细日志
tail -f logs/app.log  # 根据实际日志文件路径调整
```

## 扩展功能

系统设计具有良好的扩展性，可以轻松添加新的定时任务：

```javascript
// 在 dailyTaskService.js 中添加新任务
await addTask(
    'custom-task-name',
    '0 8 * * *',  // 每天8:00执行
    async () => {
        // 自定义任务逻辑
    }
);
```

通过这个系统，您可以确保加密货币数据的及时更新，同时保持系统的稳定性和可维护性。